# Docker Compose with 1Password environment injection
# Run with: op run --env-file .env.tpl -- docker compose up
#
# Create .env.tpl first:
#   op-env-export.sh my-app-dev Development --format op-refs > .env.tpl

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      # These will be injected from 1Password via op run
      - NODE_ENV=${APP_ENV:-development}
      - API_KEY=${API_KEY}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}
    depends_on:
      - db
      - redis

  db:
    image: postgres:16
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    command: redis-server --requirepass ${REDIS_PASSWORD:-}
    ports:
      - "6379:6379"

volumes:
  postgres_data:

# Usage:
# 1. Create environment in 1Password:
#    op-env-create.sh my-app-dev Development \
#      DB_NAME=myapp DB_USER=admin DB_PASSWORD=secret ...
#
# 2. Export as template:
#    op-env-export.sh my-app-dev Development --format op-refs > .env.tpl
#
# 3. Run with secrets injection:
#    op run --env-file .env.tpl -- docker compose up
