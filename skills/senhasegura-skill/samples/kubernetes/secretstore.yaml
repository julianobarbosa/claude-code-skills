# Senhasegura DSM SecretStore for External Secrets Operator
# Prerequisites:
# 1. External Secrets Operator installed
# 2. Authentication secret created (see auth-secret.yaml)

---
# Authentication Secret
apiVersion: v1
kind: Secret
metadata:
  name: senhasegura-auth
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: senhasegura
    app.kubernetes.io/component: auth
type: Opaque
stringData:
  clientId: "your-oauth2-client-id"
  clientSecret: "your-oauth2-client-secret"

---
# Namespace-scoped SecretStore
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: senhasegura-dsm
  namespace: default
  labels:
    app.kubernetes.io/name: senhasegura
    app.kubernetes.io/component: secretstore
spec:
  provider:
    senhasegura:
      # Your senhasegura instance URL
      url: "https://senhasegura.example.com"
      # Module to use: DSM for DevOps Secrets Management
      module: DSM
      auth:
        # Client ID reference
        clientId:
          secretRef:
            name: senhasegura-auth
            key: clientId
            namespace: external-secrets
        # Client Secret reference
        clientSecretSecretRef:
          name: senhasegura-auth
          key: clientSecret
          namespace: external-secrets
      # Optional: Skip TLS verification (NOT recommended for production)
      # ignoreSslCertificate: false

---
# ClusterSecretStore for multi-namespace access
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: senhasegura-dsm-global
  labels:
    app.kubernetes.io/name: senhasegura
    app.kubernetes.io/component: clustersecretstore
spec:
  provider:
    senhasegura:
      url: "https://senhasegura.example.com"
      module: DSM
      auth:
        clientId:
          secretRef:
            name: senhasegura-auth
            key: clientId
            namespace: external-secrets
        clientSecretSecretRef:
          name: senhasegura-auth
          key: clientSecret
          namespace: external-secrets
  # Optional: Restrict which namespaces can use this ClusterSecretStore
  conditions:
    - namespaceSelector:
        matchLabels:
          senhasegura-enabled: "true"
