# Senhasegura ExternalSecret Examples
# Syncs secrets from Senhasegura DSM to Kubernetes

---
# Example 1: Database Credentials with explicit key mapping
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: default
  labels:
    app.kubernetes.io/name: myapp
    app.kubernetes.io/component: database
spec:
  # How often to sync secrets
  refreshInterval: 1h

  # Reference to SecretStore
  secretStoreRef:
    name: senhasegura-dsm
    kind: SecretStore

  # Target Kubernetes secret configuration
  target:
    name: db-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: myapp
        annotations:
          managed-by: external-secrets

  # Map specific keys from Senhasegura
  data:
    - secretKey: DB_HOST
      remoteRef:
        key: database-prod  # Secret identifier in Senhasegura
        property: host

    - secretKey: DB_PORT
      remoteRef:
        key: database-prod
        property: port

    - secretKey: DB_USERNAME
      remoteRef:
        key: database-prod
        property: username

    - secretKey: DB_PASSWORD
      remoteRef:
        key: database-prod
        property: password

    - secretKey: DB_NAME
      remoteRef:
        key: database-prod
        property: database

---
# Example 2: API Configuration - Extract all fields
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-configuration
  namespace: default
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: senhasegura-dsm
    kind: SecretStore
  target:
    name: api-config
    creationPolicy: Owner
  # Extract all fields from the secret
  dataFrom:
    - extract:
        key: api-settings-prod
        # All fields from api-settings-prod become secret keys

---
# Example 3: Multiple secrets combined
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: application-secrets
  namespace: default
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: senhasegura-dsm
    kind: SecretStore
  target:
    name: app-secrets
    creationPolicy: Owner
  data:
    # From database secret
    - secretKey: DATABASE_URL
      remoteRef:
        key: database-prod
        property: connection_string

    # From redis secret
    - secretKey: REDIS_URL
      remoteRef:
        key: redis-prod
        property: url

    # From JWT secret
    - secretKey: JWT_SECRET
      remoteRef:
        key: jwt-keys-prod
        property: secret

    # From external API
    - secretKey: EXTERNAL_API_KEY
      remoteRef:
        key: third-party-api
        property: api_key

---
# Example 4: Using ClusterSecretStore
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: shared-credentials
  namespace: production
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: senhasegura-dsm-global
    kind: ClusterSecretStore  # Reference ClusterSecretStore
  target:
    name: shared-secret
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: shared-services-prod

---
# Example 5: Secret with templating
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: connection-string
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: senhasegura-dsm
    kind: SecretStore
  target:
    name: connection-strings
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Template the connection string
        DATABASE_URL: |
          postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode=require
        REDIS_URL: |
          redis://:{{ .redis_password }}@{{ .redis_host }}:6379/0
  data:
    - secretKey: username
      remoteRef:
        key: database-prod
        property: username
    - secretKey: password
      remoteRef:
        key: database-prod
        property: password
    - secretKey: host
      remoteRef:
        key: database-prod
        property: host
    - secretKey: port
      remoteRef:
        key: database-prod
        property: port
    - secretKey: database
      remoteRef:
        key: database-prod
        property: database
    - secretKey: redis_host
      remoteRef:
        key: redis-prod
        property: host
    - secretKey: redis_password
      remoteRef:
        key: redis-prod
        property: password

---
# Example 6: TLS Certificate from Senhasegura
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tls-certificate
  namespace: default
spec:
  refreshInterval: 24h  # Check daily for certificate rotation
  secretStoreRef:
    name: senhasegura-dsm
    kind: SecretStore
  target:
    name: app-tls
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
      data:
        tls.crt: "{{ .certificate }}"
        tls.key: "{{ .private_key }}"
  data:
    - secretKey: certificate
      remoteRef:
        key: app-tls-cert-prod
        property: certificate
    - secretKey: private_key
      remoteRef:
        key: app-tls-cert-prod
        property: private_key
